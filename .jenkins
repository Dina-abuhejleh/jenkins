pipeline {
    agent any
    environment {
        hostname =sh(returnStdout: true, script: "hostname")
        users =sh(returnStdout: true, script: "w")
        EMAIL_TO = 'deena.ah26@gmail.com'
        FILES_LIST = sh (script: "ls   '${HUDSON_HOME}'", returnStdout: true).trim()
        EXECUTOR_NUMBER=2
        
    }
    stages {
        stage('SSH') {
          steps {
           script {                 
             	def remote = [:]
                remote.name = "${IP}"
            	remote.host = "${IP}"
            	remote.allowAnyHosts = true
                remote.user = "${username}"
   		        remote.password = "${password}"
  	            writeFile file: "${env.BUILD_ID}.tar.gz", text: "#!/bin/bash\nfree -m | awk 'NR==2{printf \"%.2f%% \",\$3*100/\$2}' | tee out.txt \n echo \n >> out.txt \nhostname | tee -a out.txt \nw | tee -a out.txt"
                sshScript remote: remote, script: "${env.BUILD_ID}.tar.gz"
                def memory = sshCommand remote: remote, command: "free -m | awk 'NR==2{printf \"%.2f \",\$3*100/\$2}'"
                echo "Result: " + memory
                 if (Float.valueOf(memory) > 80.0) { 
                        error 'memory'
                    } 
                 else { 
                 }
                
                
            	
     }
  }
} 
        
                
        
        stage('Build') {
            steps {
                script {
                    echo "${IP}"
                    sh "echo 'memory usage = ${env.memory}, hostname = ${env.hostname}, users info = ${env.users}'  >> ${env.BUILD_ID}.tar.gz"
                    
                        
                }    
            }
        } 
        stage('run-parallel-branches') {
          steps {
            parallel(
              a: {
               sh 'env'
              },
              b: {
               echo "FILES_LIST : ${env.FILES_LIST}"
              }
              )
        }
 }
    }
    post {
     failure {
         emailext body: 'Check console output at $memory to view the results.${BUILD_LOG, maxLines=100, escapeHtml=false}', 
                    to: "${EMAIL_TO}", 
                    subject: 'Build failed in Jenkins: $PROJECT_NAME - #$BUILD_NUMBER'
     }
    }
}
