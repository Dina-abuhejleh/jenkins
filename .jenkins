pipeline {
    agent any
    environment {
        memory =sh(returnStdout: true, script: "free -m | awk 'NR==2{printf \"%.2f\",\$3*100/\$2}'")
        hostname =sh(returnStdout: true, script: "hostname")
        users =sh(returnStdout: true, script: "w")
        EMAIL_TO = 'deena.ah26@gmail.com'
        
    }
    stages {
          
        stage('Build') {
            steps {
                script {
                    sh "echo '${env.memory}, ${env.hostname}, ${env.users}'  >> ${env.BUILD_ID}.txt"
                    if (Float.valueOf(env.memory) > 80.0) { 
                        error 'env.memory'
                    } 
                        
                }    
            }
        }     
    }
    post {
     failure {
         emailext body: 'Check console output at $memory to view the results.${BUILD_LOG, maxLines=100, escapeHtml=false}', 
                    to: "${EMAIL_TO}", 
                    subject: 'Build failed in Jenkins: $PROJECT_NAME - #$BUILD_NUMBER'
     }
    }
}
